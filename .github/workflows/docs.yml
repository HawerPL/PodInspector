name: Generate API Documentation

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - ".github/workflows/docs.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          npm install --ignore-scripts -g @redocly/cli

      - name: Generate OpenAPI JSON
        run: |
          mkdir -p docs
          python << 'EOF'
          import json
          import sys
          try:
              from app.main import app
              spec = app.openapi()
              with open('docs/openapi.json', 'w') as f:
                  json.dump(spec, f, indent=2)
              print("‚úì OpenAPI specification generated")
          except Exception as e:
              print(f"Error generating spec: {e}", file=sys.stderr)
              sys.exit(1)
          EOF

      - name: Validate OpenAPI specification
        run: |
          if [ ! -f docs/openapi.json ]; then
            echo "Error: openapi.json not found"
            exit 1
          fi
          echo "‚úì OpenAPI JSON exists"

      - name: Generate ReDoc HTML
        run: |
          mkdir -p docs/redoc
          npx @redocly/cli build-docs docs/openapi.json \
            --output docs/redoc/index.html \
            --title 'PodInspector API'

      - name: Generate Swagger UI
        run: |
          mkdir -p docs/swagger
          cat > docs/swagger/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
            <head>
              <title>Swagger UI - PodInspector API</title>
              <meta charset="utf-8"/>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/5.11.0/swagger-ui.min.css">
              <style>
                html { box-sizing: border-box; overflow: -moz-scrollbars-vertical; overflow-y: scroll; }
                *, *:before, *:after { box-sizing: inherit; }
                body { margin: 0; padding: 0; }
              </style>
            </head>
            <body>
              <div id="swagger-ui"></div>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/5.11.0/swagger-ui-bundle.min.js"></script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/5.11.0/swagger-ui-standalone-preset.min.js"></script>
              <script>
              window.onload = function() {
                SwaggerUIBundle({
                  url: '../openapi.json',
                  dom_id: '#swagger-ui',
                  presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                  ],
                  layout: "StandaloneLayout",
                  deepLinking: true,
                  displayRequestDuration: true,
                  filter: true
                })
              }
              </script>
            </body>
          </html>
          EOF

      - name: Create main documentation index
        run: |
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>PodInspector API Documentation</title>
              <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  min-height: 100vh;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  padding: 20px;
                }
                .container {
                  background: white;
                  border-radius: 12px;
                  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                  padding: 60px 40px;
                  max-width: 700px;
                  width: 100%;
                }
                h1 {
                  color: #333;
                  font-size: 32px;
                  margin-bottom: 15px;
                  text-align: center;
                }
                .subtitle {
                  color: #666;
                  text-align: center;
                  margin-bottom: 40px;
                  font-size: 16px;
                }
                .docs-grid {
                  display: grid;
                  gap: 20px;
                  margin-bottom: 30px;
                }
                .doc-card {
                  display: block;
                  padding: 25px;
                  background: linear-gradient(135deg, #f5f7fa 0%, #eff0f5 100%);
                  border: 2px solid #e0e0e0;
                  border-radius: 8px;
                  text-decoration: none;
                  color: inherit;
                  transition: all 0.3s ease;
                  cursor: pointer;
                }
                .doc-card:hover {
                  transform: translateY(-5px);
                  box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
                  border-color: #667eea;
                }
                .doc-card-icon {
                  font-size: 32px;
                  margin-bottom: 12px;
                }
                .doc-card-title {
                  font-weight: 600;
                  color: #333;
                  font-size: 18px;
                  margin-bottom: 8px;
                }
                .doc-card-desc {
                  color: #666;
                  font-size: 14px;
                  line-height: 1.5;
                }
                .links {
                  text-align: center;
                  padding-top: 20px;
                  border-top: 1px solid #e0e0e0;
                  color: #666;
                  font-size: 14px;
                }
                .links a {
                  color: #667eea;
                  text-decoration: none;
                  margin: 0 10px;
                }
                .links a:hover {
                  text-decoration: underline;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <h1>üîç PodInspector API</h1>
                <p class="subtitle">Interactive API Documentation</p>
                
                <div class="docs-grid">
                  <a href="./redoc/index.html" class="doc-card">
                    <div class="doc-card-icon">üìö</div>
                    <div class="doc-card-title">ReDoc</div>
                    <div class="doc-card-desc">Beautiful, responsive API documentation with a clean layout</div>
                  </a>
                  
                  <a href="./swagger/index.html" class="doc-card">
                    <div class="doc-card-icon">üîß</div>
                    <div class="doc-card-title">Swagger UI</div>
                    <div class="doc-card-desc">Interactive API explorer - try out endpoints directly</div>
                  </a>
                  
                  <a href="./openapi.json" class="doc-card">
                    <div class="doc-card-icon">‚öôÔ∏è</div>
                    <div class="doc-card-title">OpenAPI Spec</div>
                    <div class="doc-card-desc">Machine-readable OpenAPI 3.0.0 specification (JSON)</div>
                  </a>
                </div>

                <div class="links">
                  Generated automatically from FastAPI application
                </div>
              </div>
            </body>
          </html>
          EOF

      - name: Verify generated files
        run: |
          echo "Checking generated files..."
          test -f docs/index.html && echo "‚úì index.html"
          test -f docs/openapi.json && echo "‚úì openapi.json"
          test -f docs/redoc/index.html && echo "‚úì redoc/index.html"
          test -f docs/swagger/index.html && echo "‚úì swagger/index.html"
          echo "All files generated successfully!"

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4